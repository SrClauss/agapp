name: iOS Build

on:
  push:
    branches:
      - main
    paths:
      - 'mobile/**'
      - '.github/workflows/ios-build.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'mobile/**'
  workflow_dispatch:

jobs:
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    
    defaults:
      run:
        working-directory: mobile
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Generate iOS native project
        run: npx expo prebuild --platform ios --clean
      
      - name: Setup Ruby for CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: false
      
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update
        env:
          COCOAPODS_DISABLE_STATS: true
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Build iOS app
        run: |
          cd ios
          xcodebuild \
            -workspace mobile.xcworkspace \
            -scheme mobile \
            -configuration Release \
            -sdk iphoneos \
            -destination 'generic/platform=iOS' \
            -archivePath $PWD/build/mobile.xcarchive \
            archive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGN_ENTITLEMENTS="" \
            | xcpretty
        env:
          NSUnbufferedIO: YES
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-build
          path: mobile/ios/build/mobile.xcarchive
          retention-days: 7
      
      - name: Build status
        if: success()
        run: echo "✅ iOS build completed successfully!"
  
  test-ios:
    name: Run iOS Tests
    runs-on: macos-latest
    
    defaults:
      run:
        working-directory: mobile
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mobile/package-lock.json
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run JavaScript tests
        run: npm test -- --ci --coverage --maxWorkers=2
        if: always()
      
      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      
      - name: Generate iOS native project
        run: npx expo prebuild --platform ios --clean
      
      - name: Setup Ruby for CocoaPods
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
      
      - name: Install CocoaPods dependencies
        run: |
          cd ios
          pod install --repo-update
      
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.2'
      
      - name: Start iPhone 15 Simulator
        run: |
          # List available simulators
          xcrun simctl list devices
          
          # Boot iPhone 15 simulator
          SIMULATOR_ID=$(xcrun simctl list devices | grep "iPhone 15 (" | grep -v "Plus\|Pro" | head -n 1 | sed -n 's/.*(\(.*\)).*/\1/p')
          echo "Starting simulator: $SIMULATOR_ID"
          xcrun simctl boot "$SIMULATOR_ID" || true
          
          # Wait for simulator to boot
          xcrun simctl bootstatus "$SIMULATOR_ID"
          
          echo "SIMULATOR_ID=$SIMULATOR_ID" >> $GITHUB_ENV
      
      - name: Run integration tests on simulator
        run: |
          cd ios
          xcodebuild test \
            -workspace mobile.xcworkspace \
            -scheme mobile \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
            -only-testing:mobileTests \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            | xcpretty --test
        continue-on-error: true
        if: always()
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            mobile/coverage/
            mobile/ios/build/Logs/Test/
          retention-days: 7
      
      - name: Test status
        if: success()
        run: echo "✅ iOS tests completed successfully!"
