{% extends "admin/base.html" %}

{% block title %}Publicidade - Painel Administrativo{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="mb-4">
    <h1 class="h3 mb-1 text-gray-800 fw-bold">Gerenciamento de Publicidade</h1>
    <p class="text-muted mb-0">Gerencie anúncios exibidos no aplicativo móvel</p>
</div>
<!-- debug status removed -->

<!-- Alert Container -->
<div id="alert-container"></div>

<!-- Ads Grid -->
<div class="row g-4">
    <!-- PubliScreen Cliente -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>PubliScreen Cliente</h5>
                <small>Tela cheia exibida após login do cliente</small>
            </div>
            <div class="card-body">
                <form id="form-publi-client" class="upload-form" data-ad-type="publi_client">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Arquivos do Anúncio</label>
                        <input type="file" class="form-control" multiple accept=".html,.htm,.css,.js,.png,.jpg,.jpeg,.gif,.svg,.webp">
                        <div class="form-text">HTML, CSS, JS e imagens. Máx 5MB por arquivo.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-1"></i>Fazer Upload
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="openPreviewLocation('publi_client')">
                            <i class="fas fa-mobile-alt me-1"></i>Preview Mobile
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="openDesktopPreviewLocation('publi_client')">
                            <i class="fas fa-desktop me-1"></i>Preview Desktop
                        </button>
                    </div>
                </form>

                <hr class="my-3">

                <div class="file-list" id="files-publi-client">
                    <small class="text-muted">Carregando arquivos...</small>
                </div>

                <div class="mt-3 text-center">
                    <!-- JS-enhanced button (shown when JS enabled) -->
                    <button type="button" class="btn btn-danger btn-sm w-100 clear-dir-btn" data-ad-type="publi_client">
                        <i class="fas fa-trash-alt me-1"></i>Limpar Todos os Arquivos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PubliScreen Profissional -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>PubliScreen Profissional</h5>
                <small>Tela cheia exibida após login do profissional</small>
            </div>
            <div class="card-body">
                <form id="form-publi-professional" class="upload-form" data-ad-type="publi_professional">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Arquivos do Anúncio</label>
                        <input type="file" class="form-control" multiple accept=".html,.htm,.css,.js,.png,.jpg,.jpeg,.gif,.svg,.webp">
                        <div class="form-text">HTML, CSS, JS e imagens. Máx 5MB por arquivo.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-upload me-1"></i>Fazer Upload
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="openPreviewLocation('publi_professional')">
                            <i class="fas fa-mobile-alt me-1"></i>Preview Mobile
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="openDesktopPreviewLocation('publi_professional')">
                            <i class="fas fa-desktop me-1"></i>Preview Desktop
                        </button>
                    </div>
                </form>

                <hr class="my-3">

                <div class="file-list" id="files-publi-professional">
                    <small class="text-muted">Carregando arquivos...</small>
                </div>

                <div class="mt-3 text-center">
                    <!-- JS-enhanced button (shown when JS enabled) -->
                    <button type="button" class="btn btn-danger btn-sm w-100 clear-dir-btn" data-ad-type="publi_professional">
                        <i class="fas fa-trash-alt me-1"></i>Limpar Todos os Arquivos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Banner Cliente -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-rectangle-ad me-2"></i>Banner Cliente</h5>
                <small>Banner exibido na tela home do cliente</small>
            </div>
            <div class="card-body">
                <form id="form-banner-client" class="upload-form" data-ad-type="banner_client">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Arquivos do Banner</label>
                        <input type="file" class="form-control" multiple accept=".html,.htm,.css,.js,.png,.jpg,.jpeg,.gif,.svg,.webp">
                        <div class="form-text">HTML, CSS, JS e imagens. Máx 5MB por arquivo.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-info">
                            <i class="fas fa-upload me-1"></i>Fazer Upload
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="openPreviewLocation('banner_client')">
                            <i class="fas fa-mobile-alt me-1"></i>Preview Mobile
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="openDesktopPreviewLocation('banner_client')">
                            <i class="fas fa-desktop me-1"></i>Preview Desktop
                        </button>
                    </div>
                </form>

                <hr class="my-3">

                <div class="file-list" id="files-banner-client">
                    <small class="text-muted">Carregando arquivos...</small>
                </div>

                <div class="mt-3 text-center">
                    <!-- JS-enhanced button (shown when JS enabled) -->
                    <button type="button" class="btn btn-danger btn-sm w-100 clear-dir-btn" data-ad-type="banner_client">
                        <i class="fas fa-trash-alt me-1"></i>Limpar Todos os Arquivos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Banner Profissional -->
    <div class="col-12 col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0"><i class="fas fa-rectangle-ad me-2"></i>Banner Profissional</h5>
                <small>Banner exibido na tela home do profissional</small>
            </div>
            <div class="card-body">
                <form id="form-banner-professional" class="upload-form" data-ad-type="banner_professional">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Arquivos do Banner</label>
                        <input type="file" class="form-control" multiple accept=".html,.htm,.css,.js,.png,.jpg,.jpeg,.gif,.svg,.webp">
                        <div class="form-text">HTML, CSS, JS e imagens. Máx 5MB por arquivo.</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-warning">
                            <i class="fas fa-upload me-1"></i>Fazer Upload
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="openPreviewLocation('banner_professional')">
                            <i class="fas fa-mobile-alt me-1"></i>Preview Mobile
                        </button>
                        <button type="button" class="btn btn-outline-info" onclick="openDesktopPreviewLocation('banner_professional')">
                            <i class="fas fa-desktop me-1"></i>Preview Desktop
                        </button>
                    </div>
                </form>

                <hr class="my-3">

                <div class="file-list" id="files-banner-professional">
                    <small class="text-muted">Carregando arquivos...</small>
                </div>

                <div class="mt-3 text-center">
                    <!-- JS-enhanced button (shown when JS enabled) -->
                    <button type="button" class="btn btn-danger btn-sm w-100 clear-dir-btn" data-ad-type="banner_professional">
                        <i class="fas fa-trash-alt me-1"></i>Limpar Todos os Arquivos
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.file-list {
    height: 120px;
    overflow-y: auto;
    overflow-x: hidden;
}

.file-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: #f8f9fa;
    border-radius: 6px;
    margin-bottom: 0.5rem;
}

.file-item:hover {
    background: #e9ecef;
}

.file-name {
    font-size: 0.875rem;
    font-family: monospace;
}

.badge-file {
    font-size: 0.7rem;
    padding: 0.25rem 0.5rem;
}

.upload-progress {
    margin-top: 1rem;
}

.btn.clear-dir-btn { font-size: 0.8rem; padding: 0.25rem 0.5rem; }
</style>

<script>
function showAlert(message, type = 'success') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.getElementById('alert-container').appendChild(alert);

    setTimeout(() => {
        alert.remove();
    }, 5000);
}

// Load files for each ad type
function mapAdTypeToLocation(adType) {
    const map = {
        'publi_client': 'publi_screen_client',
        'publi_professional': 'publi_screen_professional',
        'banner_client': 'banner_client_home',
        'banner_professional': 'banner_professional_home'
    };
    return map[adType] || adType;
}

async function loadFiles(adType) {
    const container = document.getElementById(`files-${adType.replace('_', '-')}`);
    const location = mapAdTypeToLocation(adType);

    try {
        // Use the admin locations endpoint and filter by location
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/ads-admin/locations`, {
            method: 'GET',
            credentials: 'include',
            headers: {
                'Accept': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
        });
        if (!response.ok) {
            container.innerHTML = '<small class="text-muted">Nenhum arquivo encontrado</small>';
            return;
        }

        const data = await response.json();
        const locations = data.locations || [];
        const loc = locations.find(l => l.location === location);
        const files = loc && loc.files ? loc.files : [];

        if (files.length === 0) {
            container.innerHTML = '<small class="text-muted">Nenhum arquivo enviado ainda</small>';
            return;
        }

        container.innerHTML = files.map(file => `
            <div class="file-item">
                <div>
                    <span class="file-name">${file.name}</span>
                    ${file.link ? `<small class="text-muted d-block">Link: <a href="${file.link}" target="_blank">${file.link}</a></small>` : ''}
                    <span class="badge badge-file ${file.name.endsWith('.html') ? 'bg-primary' : file.name.endsWith('.css') ? 'bg-info' : file.name.endsWith('.js') ? 'bg-warning' : 'bg-secondary'} ms-2">
                        ${file.name.split('.').pop().toUpperCase()}
                    </span>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-danger" onclick="deleteFile('${adType}', '${file.name}')">
                        <i class="fas fa-trash"></i>
                    </button>
                    ${ file.name.endsWith('.png') || file.name.endsWith('.jpg') || file.name.endsWith('.jpeg') || file.name.endsWith('.webp') || file.name.endsWith('.gif') || file.name.endsWith('.svg') ?
                    `
                    <button class="btn btn-sm btn-outline-secondary" onclick="editImageLink('${adType}', '${file.name}')">
                        <i class="fas fa-link"></i>
                    </button>
                    ` : '' }
                </div>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading files:', error);
        container.innerHTML = '<small class="text-danger">Erro ao carregar arquivos</small>';
    }
}

// Delete file
async function deleteFile(adType, filename) {
    if (!confirm(`Deseja deletar ${filename}?`)) return;
    const location = mapAdTypeToLocation(adType);

    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/ads-admin/delete-file/${location}/${encodeURIComponent(filename)}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
        });

        if (!response.ok) throw new Error('Failed to delete');

        showAlert(`Arquivo ${filename} deletado com sucesso!`, 'success');
        loadFiles(adType);
    } catch (error) {
        showAlert('Erro ao deletar arquivo', 'danger');
    }
}

// Edit image link metadata
async function editImageLink(adType, filename) {
    const location = mapAdTypeToLocation(adType);
    const currentLink = prompt('Insira o link para o clique (deixe vazio para remover):');
    try {
        const token = localStorage.getItem('access_token');
        const formData = new FormData();
        formData.append('link', currentLink || '');
        const response = await fetch(`/ads-admin/image/meta/${location}/${encodeURIComponent(filename)}`, {
            method: 'POST',
            credentials: 'include',
            headers: {
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            },
            body: formData
        });
        if (!response.ok) throw new Error('Failed to set image link');
        showAlert('Link atualizado com sucesso', 'success');
        loadFiles(adType);
    } catch (error) {
        console.error('Error setting image link', error);
        showAlert('Erro ao atualizar link da imagem', 'danger');
    }
}

// Delete all files in a location (admin only)
async function deleteAllFilesByLocation(location) {
    try {
        const token = localStorage.getItem('access_token');
        const response = await fetch(`/ads-admin/delete-all/${location}`, {
            method: 'DELETE',
            credentials: 'include',
            headers: {
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            }
        });

        if (!response.ok) {
            const text = await response.text();
            throw new Error('Delete failed: ' + text);
        }

        showAlert(`Conteúdo de ${location} removido com sucesso`, 'success');

        // re-enable buttons if any were disabled
        document.querySelectorAll('.clear-dir-btn').forEach(btn => btn.disabled = false);
        // find adType from location and reload files
        const map = {
            'publi_screen_client': 'publi_client',
            'publi_screen_professional': 'publi_professional',
            'banner_client_home': 'banner_client',
            'banner_professional_home': 'banner_professional'
        };
        const adType = map[location] || location;
        loadFiles(adType);
    } catch (error) {
        console.error('Delete error:', error);
        showAlert('Erro ao limpar diretório', 'danger');
        document.querySelectorAll('.clear-dir-btn').forEach(btn => btn.disabled = false);
    }
}

// Attach clear directory event handlers to buttons
function clearLocationHandler(e) {
    const btn = e.currentTarget;
    const adType = btn.dataset.adType;
    if (!confirm('Deseja remover todos os arquivos deste diretório? Esta operação não pode ser desfeita.')) {
        return;
    }
    // Disable button while deleting to prevent duplicates
    btn.disabled = true;
    const location = mapAdTypeToLocation(adType);
    deleteAllFilesByLocation(location);
}

// Attach handlers once DOM is ready
function attachClearDirHandlers() {
    const buttons = document.querySelectorAll('.clear-dir-btn');
    buttons.forEach((btn) => {
        btn.removeEventListener('click', clearLocationHandler);
        btn.addEventListener('click', clearLocationHandler);
    });
}

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachClearDirHandlers);
} else {
    attachClearDirHandlers();
}

// Determine file_type from filename extension
function getFileTypeFromFilename(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (['html', 'htm'].includes(ext)) return 'html';
    if (ext === 'css') return 'css';
    if (ext === 'js') return 'js';
    return 'image';
}

// Handle form submissions
document.querySelectorAll('.upload-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const adType = form.dataset.adType;
        const fileInput = form.querySelector('input[type="file"]');
        const files = fileInput.files;

        if (files.length === 0) {
            showAlert('Selecione pelo menos um arquivo', 'warning');
            return;
        }

        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Enviando...';

        let successCount = 0;
        let errorCount = 0;

        const location = mapAdTypeToLocation(adType);
        for (const file of files) {
            const formData = new FormData();
            formData.append('file', file);
                // append file_type for the new admin endpoint
                const fileType = getFileTypeFromFilename(file.name);
                formData.append('file_type', fileType);

            try {
                    const token = localStorage.getItem('access_token');
                    const response = await fetch(`/ads-admin/upload/${location}`, {
                            method: 'POST',
                            credentials: 'include',
                            headers: {
                                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
                            },
                            body: formData
                        });

                if (!response.ok) throw new Error('Upload failed');

                successCount++;
            } catch (error) {
                console.error('Upload error:', error);
                errorCount++;
            }
        }

        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;

        if (errorCount === 0) {
            showAlert(`${successCount} arquivo(s) enviado(s) com sucesso!`, 'success');
            fileInput.value = '';
            loadFiles(adType);
        } else {
            showAlert(`${successCount} enviado(s), ${errorCount} erro(s)`, 'warning');
        }
    });
});

// Preview modal functions
function openPreview(url) {
    const modal = document.getElementById('preview-modal');
    const iframe = document.getElementById('preview-iframe');
    iframe.src = url;
    modal.style.display = 'block';
}

function openDesktopPreview(url) {
    window.open(url, '_blank');
}

function closePreview() {
    const modal = document.getElementById('preview-modal');
    const iframe = document.getElementById('preview-iframe');
    modal.style.display = 'none';
    iframe.src = '';
}

function openPreviewLocation(adType) {
    const location = mapAdTypeToLocation(adType);
    openPreview(`/ads-admin/preview-html/${location}`);
}

function openDesktopPreviewLocation(adType) {
    const location = mapAdTypeToLocation(adType);
    // Open the admin preview HTML route in a new tab/window for desktop preview
    openDesktopPreview(`/ads-admin/preview-html/${location}`);
}

// Load files on page load
document.addEventListener('DOMContentLoaded', () => {
    loadFiles('publi_client');
    loadFiles('publi_professional');
    loadFiles('banner_client');
    loadFiles('banner_professional');
});
</script>

<!-- Preview Modal -->
<div id="preview-modal" class="modal" style="display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="position: relative; margin: auto; top: 50%; transform: translateY(-50%); width: 90%; max-width: 400px; max-height: 90vh;">
        <div class="modal-header" style="background: #f8f9fa; padding: 10px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin: 0; font-size: 1.1rem;">Preview Mobile</h5>
            <button type="button" class="btn-close" onclick="closePreview()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>
        <div class="modal-body" style="padding: 0; border-radius: 0 0 10px 10px; overflow: hidden;">
            <div class="phone-frame" style="width: 100%; height: 0; padding-bottom: 200%; position: relative; border-radius: 20px; box-shadow: 0 0 20px rgba(0,0,0,0.3);">
                <iframe id="preview-iframe" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none; border-radius: 20px;" allowfullscreen></iframe>
            </div>
        </div>
    </div>
</div>

{% endblock %}
