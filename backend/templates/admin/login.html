<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Administrativo - Agiliza</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-primary">
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-xl-6 col-lg-7 col-md-9">
                <div class="card o-hidden border-0 shadow-lg my-5">
                    <div class="card-body p-0">
                        <!-- Nested Row within Card Body -->
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="p-5">
                                    <div class="text-center">
                                        <h1 class="h4 text-gray-900 mb-4">Login Administrativo</h1>
                                        <p class="text-muted">Acesse o painel de administração do Agiliza</p>
                                    </div>

                                    {% if error %}
                                    <div class="alert alert-danger" role="alert">
                                        {{ error }}
                                    </div>
                                    {% endif %}

                                    <div id="login-feedback" class="mb-3" style="display:none;"></div>

                                    <form id="admin-login-form" class="user" method="post" action="/system-admin/login">
                                        <!-- Honeypot field - invisible to humans, visible to bots -->
                                        <div class="form-group" style="display:none !important; position:absolute; left:-9999px;">
                                            <label for="website">Website (leave blank)</label>
                                            <input type="text" class="form-control" id="website" name="website" autocomplete="off">
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label for="email" class="form-label small text-muted">Email</label>
                                            <input type="email" class="form-control form-control-user" id="email" name="username" aria-describedby="emailHelp" placeholder="Digite seu email..." required>
                                        </div>
                                        <div class="form-group mb-3">
                                            <label for="password" class="form-label small text-muted">Senha</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control form-control-user" id="password" name="password" placeholder="Senha" required>
                                                <button class="btn btn-outline-secondary" type="button" id="toggle-password">
                                                    <i class="fas fa-eye" id="password-icon"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="d-grid">
                                            <button id="login-btn" type="submit" class="btn btn-primary btn-user">
                                                <span id="login-btn-text">Entrar</span>
                                                <span id="login-spinner" class="spinner-border spinner-border-sm ms-2" role="status" aria-hidden="true" style="display:none;"></span>
                                            </button>
                                        </div>
                                    </form>

                                    <hr>
                                    <div class="text-center">
                                        <a class="small" href="/">Voltar ao Site</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    .bg-gradient-primary {
        background: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
    }

    .btn-user {
        padding: 0.75rem 1rem;
        border-radius: 10rem;
        font-size: 0.9rem;
        font-weight: 600;
        letter-spacing: 0.1rem;
    }

    .form-control-user {
        border-radius: 10rem;
        padding: 1.5rem 1rem;
        border: 1px solid #d1d3e2;
    }

    .form-control-user:focus {
        border-color: #bac8f3;
        box-shadow: 0 0 0 0.2rem rgba(78, 115, 223, 0.25);
    }
    
    .input-group .btn {
        border-radius: 0 10rem 10rem 0;
        border-left: none;
    }
    
    .input-group .form-control-user {
        border-radius: 10rem 0 0 10rem;
    }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    (function(){
        const form = document.getElementById('admin-login-form');
        const feedback = document.getElementById('login-feedback');
        const btn = document.getElementById('login-btn');
        const spinner = document.getElementById('login-spinner');
        const btnText = document.getElementById('login-btn-text');

        function showMessage(message, type='danger'){
            feedback.style.display = 'block';
            feedback.innerHTML = `<div class="alert alert-${type} d-flex align-items-center" role="alert"><div class="me-2">` +
                (type === 'success' ? '<i class="fas fa-check-circle"></i>' : '<i class="fas fa-exclamation-triangle"></i>') +
                `</div><div>${message}</div></div>`;
        }

        form.addEventListener('submit', async function(e){
            e.preventDefault();
            feedback.style.display = 'none';
            spinner.style.display = 'inline-block';
            btn.disabled = true;
            btnText.textContent = 'Entrando...';

            const formData = new URLSearchParams(new FormData(form));

            try{
                const res = await fetch(form.action, {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: formData,
                    credentials: 'same-origin'
                });

                const dataText = await res.text();
                let data = null;
                try{ data = JSON.parse(dataText); } catch(err){ data = null; }

                if(res.ok){
                    // If JSON response indicates success, show success badge and redirect
                    if(data && data.success){
                        showMessage(data.message || 'Login efetuado com sucesso', 'success');
                        setTimeout(()=> window.location.href = '/system-admin', 900);
                    } else {
                        // If server returned HTML (redirect) fetch may follow; just redirect client
                        window.location.href = '/system-admin';
                    }
                } else {
                    // Try to extract message
                    let msg = 'Erro ao autenticar';
                    if(data && data.detail) msg = data.detail;
                    else if(data && data.message) msg = data.message;
                    showMessage(msg, 'danger');
                }
            } catch(err){
                showMessage('Erro de rede. Tente novamente.', 'danger');
            } finally {
                spinner.style.display = 'none';
                btn.disabled = false;
                btnText.textContent = 'Entrar';
            }
        });
        
        // Toggle password visibility
        const togglePasswordBtn = document.getElementById('toggle-password');
        const passwordInput = document.getElementById('password');
        const passwordIcon = document.getElementById('password-icon');
        
        togglePasswordBtn.addEventListener('click', function() {
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            
            // Toggle icon
            if (type === 'password') {
                passwordIcon.className = 'fas fa-eye';
                togglePasswordBtn.setAttribute('aria-label', 'Mostrar senha');
            } else {
                passwordIcon.className = 'fas fa-eye-slash';
                togglePasswordBtn.setAttribute('aria-label', 'Esconder senha');
            }
        });
    })();
    </script>
</body>
</html>